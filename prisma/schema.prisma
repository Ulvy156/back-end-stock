// npx prisma migrate reset
//npx prisma migrate dev --name init
//npx prisma db push


generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Role Enum
enum RoleEnum {
  ADMIN
  WAREHOUSE_MANAGER
  SELLER
  AUDITOR
}
enum WarehouseType {
  MAIN
  BRANCH
  TEMPORARY
}
enum CustomerType {
  RETAILS
  WHOLESALE
  VIP
}
// Users
model User {
  id            String          @id @default(uuid())
  name          String
  email         String          @unique
  password      String
  img_url       String?
  role          RoleEnum        @default(SELLER)
  purchases     Purchase[]      // One-to-many
  sales         Sale[]          // One-to-many
  // reverse relations
  customersCreated   Customer[]   @relation("CustomerCreatedBy")
  customersUpdated   Customer[]   @relation("CustomerUpdatedBy")
  warehouse_id  Int?             
  warehouse     Warehouse?       @relation(fields: [warehouse_id], references: [id])
  audit_logs    AuditLog[]      // One-to-many
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([role, warehouse_id])
  @@map("user")
}

model Provinces {
  id            Int       @id @default(autoincrement())
  name          String    @unique
  district      Districts[] // one-to-many
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("province")
}
model Districts {
  id            String       @id @default(uuid())
  name          String    
  province_id   Int
  province      Provinces @relation(fields: [province_id], references: [id], onDelete: Cascade)

  customers     Customer[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([province_id])
  @@unique([province_id, name]) // name unique per province
  @@map("district")

}
// Customers
model Customer {
  id            String    @id @default(uuid())
  name          String
  phone         String?   @unique
  telegram      String?

  address       String?
  img_url       String?
  lastOrderDate DateTime?
  totalOrders   Int       @default(0)
  totalSpent    Float     @default(0)
  mapUrl        String?
  sales         Sale[]    // One-to-many

  district_id   String
  district      Districts @relation(fields: [district_id], references: [id], onDelete: Cascade)

  created_by_user_id  String?   
  createdBy           User?     @relation("CustomerCreatedBy", fields: [created_by_user_id], references: [id])

  updated_by_user_id  String?   
  updatedBy           User?     @relation("CustomerUpdatedBy", fields: [updated_by_user_id], references: [id])

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([phone, telegram, created_by_user_id, district_id])
  @@map("customer")
}


// Warehouses
model Warehouse {
  id            Int               @id @default(autoincrement())
  name          String            @unique
  size          String            
  location      String           // e.g., "Hanoi", "Ho Chi Minh City"
  type          WarehouseType     @default(BRANCH)
  mapUrl        String?           // e.g., google map url
  img_url       String?
  purchases     Purchase[]        // One-to-many
  sales         Sale[]            // One-to-many
  product_stocks ProductWarehouse[] // One-to-many
  users         User[]            // Many-to-one with Users
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([type])
  @@map("warehouse")
}


// ProductWarehouse (stock per product per warehouse)
model ProductWarehouse {
  product_id    String
  warehouse_id  Int
  stock_qty     Int       @default(0)
  product       Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  warehouse     Warehouse @relation(fields: [warehouse_id], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  @@id([product_id, warehouse_id]) // cannot have the same product in the same warehouse twice
  @@index([product_id, warehouse_id]) // For fast stock lookups

  @@map("product_warehouse")
}

// Categories
model Category {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  products    Product[]   // One-to-many
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("category")
}

// Products
model Product {
  id            String            @id @default(uuid())
  name          String
  sku           String            @unique
  unit          String
  cost_price    Decimal           @db.Decimal(10, 2)
  selling_price Decimal           @db.Decimal(10, 2)
  category_id   String
  category      Category          @relation(fields: [category_id], references: [id], onDelete: Cascade)
  purchase_items PurchaseItem[]    // One-to-many
  sale_items    SaleItem[]        // One-to-many
  product_stocks ProductWarehouse[] // One-to-many
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([category_id])
  @@map("products")

}

// Purchases ( import table )
model Purchase {
  id            String          @id @default(uuid())
  user_id       String?
  warehouse_id  Int
  user          User?           @relation(fields: [user_id], references: [id], onDelete: SetNull)
  warehouse     Warehouse       @relation(fields: [warehouse_id], references: [id], onDelete: Restrict)
  date          DateTime
  total         Decimal         @db.Decimal(10, 2)
  source_country String?        // Tracks import country, e.g., "China"
  purchase_items PurchaseItem[] // One-to-many
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([user_id, warehouse_id])
  @@map("purchase")
}

// PurchaseItems ( item import from country )
model PurchaseItem {
  id            String    @id @default(uuid())
  purchase_id   String
  product_id    String
  purchase      Purchase  @relation(fields: [purchase_id], references: [id], onDelete: Cascade)
  product       Product   @relation(fields: [product_id], references: [id], onDelete: Restrict)
  qty           Int
  price         Decimal   @db.Decimal(10, 2)
  subtotal      Decimal   @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([purchase_id, product_id])
  @@map("purchase_item")
}

// Sales ( sale to customer )
model Sale {
  id            String        @id @default(uuid())
  customer_id   String
  user_id       String?
  warehouse_id  Int
  customer      Customer      @relation(fields: [customer_id], references: [id], onDelete: Restrict)
  user          User?         @relation(fields: [user_id], references: [id], onDelete: SetNull)
  warehouse     Warehouse     @relation(fields: [warehouse_id], references: [id], onDelete: Restrict)
  date          DateTime
  total         Decimal       @db.Decimal(10, 2)
  sale_items    SaleItem[]    // One-to-many
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([customer_id, warehouse_id])
  @@map("sale")
}

// SaleItems ( details sale items )
model SaleItem {
  id           String    @id @default(uuid())
  sale_id      String
  product_id   String
  sale         Sale      @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  product      Product   @relation(fields: [product_id], references: [id], onDelete: Restrict)
  qty          Int
  price        Decimal   @db.Decimal(10, 2)
  subtotal     Decimal   @db.Decimal(10, 2)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([sale_id, product_id])
  @@map("sale_item")
}

// AuditLogs ( logs all activity in system except GET method )
model AuditLog {
  id          String       @id @default(uuid())
  user_id     String?
  user        User?     @relation(fields: [user_id], references: [id], onDelete: SetNull)
  action      String    // 'login', 'create', 'update', 'delete'
  entity_type String
  entity_id   Int?
  details     Json?
  timestamp   DateTime  @default(now())

  @@map("audit_log")
}